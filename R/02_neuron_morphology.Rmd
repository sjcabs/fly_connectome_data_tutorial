---
title: "Tutorial 02: Neuron Morphology"
author: "Alexander Bates"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: show
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 8,
  cache = FALSE
)

# Setup image output directory
img_dir <- "images/tutorial_02"
if (!dir.exists(img_dir)) {
  dir.create(img_dir, recursive = TRUE)
}

# Helper function to save plots
save_plot <- function(plot_obj, name, width = 10, height = 6) {
  filename <- file.path(img_dir, paste0(name, ".png"))
  ggsave(filename, plot_obj, width = width, height = height, dpi = 300, bg = "white")
}
```

```{r packages, include=FALSE}
# Load required packages
source("setup/packages.R")
source("setup/functions.R")

# Set plotly as default 3D plot engine for nat
options(nat.plotengine = 'plotly')
```

## Introduction

The purpose of this tutorial is to examine neuron morphology.

We can visualise neurons, compare their morphological similarity with [NBLAST](https://natverse.org/nat.nblast/), and plot them with their synapses.

To do this, we are going to look at one of the data 'subsets' we have pre-prepared. 

I have subset the synapses and edgelist relevant for a few interesting areas, so let's use one of those.

You can change which subset and dataset to examine, by changing these two variables:

```{r setup_paths}
# Choose dataset and subset
dataset <- "banc_746"
dataset_id <- "banc_746_id"
data_path <- "gs://brain-and-nerve-cord_exports/sjcabs_data"
subset_name <- "front_leg"
neuropil_pattern <- "T1"

# Detect if using GCS or local path
use_gcs <- grepl("^gs://", data_path)

# Setup GCS filesystem if needed
gcs_fs <- if (use_gcs) setup_gcs_filesystem() else NULL

# Construct paths
meta_path <- construct_path(data_path, dataset, "meta")
skeletons_path <- construct_path(data_path, dataset, "skeletons")

# For subsets, construct paths to pre-filtered files
# Extract base dataset name (e.g., "banc" from "banc_746")
dataset_base <- sub("_[0-9]+$", "", dataset)
subset_dir <- file.path(data_path, dataset_base, subset_name)
edgelist_path <- file.path(subset_dir, paste0(dataset, "_", subset_name, "_simple_edgelist.feather"))
synapses_path <- file.path(subset_dir, paste0(dataset, "_", subset_name, "_synapses.feather"))

cat("Dataset:", dataset, "\n")
cat("Subset:", subset_name, "\n")
cat("Using GCS:", use_gcs, "\n")
```

But by default, let us look at the front leg neuropil!

This is available for BANC, maleCNS and MANC.

## Read Meta Data

Let's start by reading the meta data for our chosen subset:

```{r load_meta}
# Read the edgelist for this subset to get neuron IDs
edgelist <- read_feather_smart(edgelist_path, gcs_filesystem = gcs_fs)

# Get unique neuron IDs from pre and post columns
subset_ids <- unique(c(edgelist$pre, edgelist$post))
cat("Found", length(subset_ids), "unique neurons in", subset_name, "edgelist\n")

# Read full meta data using streaming approach
meta_full <- read_feather_smart(meta_path, gcs_filesystem = gcs_fs)

# Get proofread neuron IDs (key concept from Tutorial 01!)
proofread_ids <- meta_full[[dataset_id]]

# Filter meta for neurons in this subset
meta <- meta_full %>%
  filter(!!sym(dataset_id) %in% subset_ids)

# Rename ID column to 'id' for consistency
meta <- meta %>%
  rename(id = !!sym(dataset_id))

cat("Loaded", nrow(meta), "neurons in", subset_name, "subset\n")
cat("(From", nrow(meta_full), "total proofread neurons)\n")
head(meta)
```

Let's now plot the neuron counts we have, by their super class:

```{r plot_counts}
# Count neurons by super_class
counts <- meta %>%
  count(super_class, sort = TRUE)

# Create bar plot
p <- ggplot(counts, aes(x = reorder(super_class, n), y = n, fill = super_class)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), hjust = -0.2, size = 3.5) +
  coord_flip() +
  labs(
    title = paste0("Neuron Counts in ", toupper(dataset), " ", subset_name, " Neuropil"),
    x = "Super Class",
    y = "Number of Neurons"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.grid.major.y = element_blank()
  )

save_plot(p, paste0(dataset, "_", subset_name, "_neuron_counts"))
```

That's quite a lot of neurons, but not too many.

Let's make a vector of their IDs.

```{r get_ids}
# Extract neuron IDs
neuron_ids <- meta$id
cat("Total neurons:", length(neuron_ids), "\n")

# Show first few IDs
head(neuron_ids)
```

## Read .swc File

A [.swc file](http://www.neuronland.org/NLMorphologyConverter/MorphologyFormats/SWC/Spec.html) is a format for encoding neuron 'skeleton' structure.

In short, a neuron can be represented as a tree graph, in which each node has a specified "parent", except the "root". When possible, we usually "root" the neuron at the soma, i.e. cell body.

We could work with high-resolution mesh data (not in our Google bucket), but for most tasks a skeleton suffices and is faster.

If you would like to see how to read in mesh data for the BANC project, which enables nice visualisations, see [here](https://flyconnectome.github.io/bancr/reference/banc_read_neuron_meshes.html).

Let's just take one cell type to start, why not DNg12, known to play a role in the control of the front legs during [grooming](https://www.sciencedirect.com/science/article/pii/S0960982221017425).

We can read its .swc file straight from the skeleton directories (our helper functions work with both directories and .zip archives).

We can visualise it in BANC space, or in its native space if not a BANC neuron. For non-BANC datasets we provide two spaces, because visualising everything in BANC space assists us with co-visualisation. We will see an example of this later.

For now, let's read and plot that neuron!

```{r read_single_neuron}
# Get all DNg12 neurons
meta_dng12 <- meta %>%
  filter(grepl("DNg12", cell_type))

neuron_ids <- meta_dng12$id
cat("Found", length(neuron_ids), "DNg12 neurons\n")

# Read all neurons using simplified function
neurons <- read_neurons_dir(
  dir_path = skeletons_path,
  neuron_ids = neuron_ids,
  gcs_filesystem = gcs_fs
)

cat("Loaded", length(neurons), "neurons\n")

# For visualization, we'll use the first neuron
neuron <- neurons[[1]]
selected_id <- names(neurons)[1]

cat("Visualizing neuron", selected_id, "with", nrow(neuron$d), "points\n")
summary(neuron)
```

Now let's visualize this neuron interactively with plotly:

```{r plot3d_neuron, fig.width=8, fig.height=6}
# Plot single neuron with plotly (default engine)
nclear3d()
plot3d(neuron, col = "darkblue", lwd = 2, soma = 10000)
```

We can also plot multiple neurons in different colors:

```{r plot3d_multiple_neurons, fig.width=8, fig.height=6}
# Plot multiple neurons with different colors
nclear3d()
plot3d(neurons, col = rainbow(length(neurons)), lwd = 2, soma = 10000)
```

Fo publication-ready 2D images, see our [nat.ggplot](https://github.com/natverse/nat.ggplot?tab=readme-ov-file) libraries and the tutorial in its  `README`.

## Read Neuropil Meshes

In our `obj` folder, we have some useful neuroanatomical objects!

We can also show the mesh of the BANC brains and ventral nerve cord neuropils, to help contextualise this morphology.

You can find its `.obj` file in our prepared data, and visualise it with our neuron as so.

```{r simple_mesh_example, eval=TRUE, fig.width=8, fig.height=6}
# Construct paths to mesh directories
# Large anatomical regions (VNC, brain, etc.) are in obj/ directory
region_path <- file.path(data_path, dataset_base, "obj")
cat("Large region meshes path:", region_path, "\n")
region_files <- system(paste("gsutil ls", region_path), intern = TRUE)
vnc_obj <- region_files[grepl("vnc.*\\.obj$", region_files, ignore.case = TRUE)][1]
brain_obj <- region_files[grepl("brain.*\\.obj$", region_files, ignore.case = TRUE)][1]

# Download and read the mesh
temp_mesh <- tempfile(fileext = ".obj")
system(paste("gsutil cp", vnc_obj, temp_mesh))
vnc_mesh <- as.hxsurf(rgl::readOBJ(temp_mesh))
temp_mesh <- tempfile(fileext = ".obj")
system(paste("gsutil cp", brain_obj, temp_mesh))
brain_mesh <- as.hxsurf(rgl::readOBJ(temp_mesh))

# Visualize multiple neurons with neuropil mesh using plotly
nclear3d()
plot3d(vnc_mesh, col = "lightblue", alpha = 0.3)
plot3d(brain_mesh, col = "lightblue", alpha = 0.3)
plot3d(neurons, col = rainbow(length(neurons)), lwd = 2, soma = 10000)
```

Let's fetch both the BANC ventral nerve cord neuropil, and the leg neuropil.

We can show them over our neurons, with a little transparency.

```{r plot_with_neuropil, fig.width=10, fig.height=8}
# Smaller specific neuropils are in obj/neuropils/ subdirectory
neuropil_path <- file.path(data_path, dataset_base, "obj", "neuropils")
cat("Neuropil meshes path:", neuropil_path, "\n")

# List available OBJ files in the bucket
neuropil_files <- system(paste("gsutil ls", neuropil_path), intern = TRUE)

# Find VNC and leg neuropil meshes
leg_obj <- neuropil_files[grepl(neuropil_pattern, basename(neuropil_files))][1]
cat("Leg mesh:", leg_obj, "\n")

# Download and read meshes
temp_leg <- tempfile(fileext = ".obj")
if (!is.na(leg_obj) && length(leg_obj) > 0) {
  system(paste("gsutil cp", leg_obj, temp_leg))
  leg_mesh <- as.hxsurf(rgl::readOBJ(temp_leg))
}

# Plot neurons with neuropil meshes using plotly
nclear3d()

# Plot multiple neurons in different colors
n_plot <- length(neurons)
cat("Plotting", n_plot, "DNg12 neurons with neuropil context\n")
plot3d(vnc_mesh, col = "lightgrey", alpha = 0.1)
plot3d(leg_mesh, col = "lightblue", alpha = 0.3, add = TRUE)
plot3d(neurons, col = rainbow(length(neurons)), lwd = 2, soma = 10000)
# This works for the rgl version of this plot: title3d(main = paste(n_plot,
# "DNg12 Neurons in Neuropil Context"), xlab = "X (nm)", ylab = "Y (nm)", zlab =
# "Z (nm)")
```

## Transform between template spaces

Different connectomic and light-level anatomical data are collected in different individuals, and their data may be "registered" to different [template brains](https://www.virtualflybrain.org/docs/concepts/bridging/).

This plot shows the common template brains, including connectomic datasets, and the transforms that we have precomputed:

<p align="center">
  <img src="../inst/images/bridging_graph.png" alt="Template Brain Bridging Graph" width="80%">
</p>

In R, these transforms can be accessed via [nat.flybrains](https://natverse.org/nat.flybrains/index.html)

In this workshop, for each dataset we already provide transformed .swc neuron morphology data in the native dataset AND in BANC. Synapse data is given in the native dataset's space (and may be in raw voxels, nanometers or microns).

This enables you to plot things from multiple datasets in BANC easily.

For example, we can switch to looking at the maleCNS data, and read DNg12 neurons from maleCNS. We can then co-plot them in BANC space, with our BANC DNg12 neurons:

```{r coplot_malecns_banc, eval=FALSE, fig.width=10, fig.height=8}
# Switch to maleCNS dataset
dataset_male <- "malecns"
dataset_male_id <- "malecns_09_id"

# Read maleCNS meta data
meta_male_path <- construct_path(data_path, dataset_male, "meta")
meta_male_full <- read_feather_smart(meta_male_path, gcs_filesystem = gcs_fs)

# Filter for DNg12 neurons in maleCNS
meta_male_dng12 <- meta_male_full %>%
  filter(grepl("DNg12", cell_class, ignore.case = TRUE))

cat("Found", nrow(meta_male_dng12), "DNg12 neurons in maleCNS\n")

# Construct path to maleCNS skeletons in BANC space
skeletons_male_banc_path <- construct_path(data_path, dataset_male, "skeletons",
                                           space_suffix = "banc_space")

# Read maleCNS neurons (already in BANC space)
# Sample a few for visualization
n_male_sample <- min(5, nrow(meta_male_dng12))
male_ids <- meta_male_dng12$id[1:n_male_sample]

cat("Reading", n_male_sample, "maleCNS neurons from BANC space...\n")
neurons_male_banc <- read_neurons_dir(
  dir_path = skeletons_male_banc_path,
  neuron_ids = male_ids,
  gcs_filesystem = gcs_fs
)

# Convert to microns
neurons_male_banc_um <- neurons_male_banc / 1000

# Co-plot BANC and maleCNS neurons
nclear3d()

# Plot BANC DNg12 neurons in blue
cat("Plotting BANC neurons...\n")
n_banc_plot <- min(5, length(neurons_um))
for (i in 1:n_banc_plot) {
  plot3d(neurons_um[[i]], col = "darkblue", lwd = 2, add = TRUE)
}

# Plot maleCNS DNg12 neurons in red
cat("Plotting maleCNS neurons...\n")
for (i in 1:length(neurons_male_banc_um)) {
  plot3d(neurons_male_banc_um[[i]], col = "darkred", lwd = 2, add = TRUE)
}

title3d(main = "Co-visualisation: BANC (blue) vs maleCNS (red) DNg12 Neurons",
        xlab = "X (µm)", ylab = "Y (µm)", zlab = "Z (µm)")
```

However, if you want do do spatial transforms yourself, you will need to use `nat.templatebrains` and its `xform_brain` function. A bit confusingly, we will also need [bancr](https://github.com/flyconnectome/bancr?tab=readme-ov-file) to complete the bridge to BANC space.

For example, let's read the native MANC neurons

```{r xform_manc_to_banc, eval=FALSE, fig.width=10, fig.height=8}
# Download template brain registrations (only needs to be done once)
nat.flybrains::download_jefferislab_registrations()

# Switch to MANC dataset
dataset_manc <- "manc"
dataset_manc_id <- "manc_v1_id"

# Read MANC meta data
meta_manc_path <- construct_path(data_path, dataset_manc, "meta")
meta_manc_full <- read_feather_smart(meta_manc_path, gcs_filesystem = gcs_fs)

# Filter for DNg12 neurons in MANC
meta_manc_dng12 <- meta_manc_full %>%
  filter(grepl("DNg12", cell_class, ignore.case = TRUE))

cat("Found", nrow(meta_manc_dng12), "DNg12 neurons in MANC\n")

# Construct path to MANC skeletons in native MANC space
skeletons_manc_path <- construct_path(data_path, dataset_manc, "skeletons",
                                      space_suffix = paste0(dataset_manc, "_space"))

# Read MANC neurons in native space
n_manc_sample <- min(3, nrow(meta_manc_dng12))
manc_ids <- meta_manc_dng12$id[1:n_manc_sample]

cat("Reading", n_manc_sample, "MANC neurons from native space...\n")
manc_dng12 <- read_neurons_dir(
  dir_path = skeletons_manc_path,
  neuron_ids = manc_ids,
  gcs_filesystem = gcs_fs
)

# Transform MANC neurons to JRCVNC2018F template brain
cat("Transforming MANC -> JRCVNC2018F...\n")
manc_dng12_jrcvnc2018f <- xform_brain(manc_dng12,
                                      sample = "MANC",
                                      reference = "JRCVNC2018F")

# Transform from JRCVNC2018F to BANC using bancr
cat("Transforming JRCVNC2018F -> BANC...\n")
manc_dng12_banc <- bancr::banc_to_JRC2018F(manc_dng12_jrcvnc2018f,
                                           region = "vnc",
                                           method = "tpsreg",
                                           banc.units = "nm",
                                           inverse = TRUE)

# Convert to microns
manc_dng12_banc_um <- manc_dng12_banc / 1000

# Co-plot MANC neurons with BANC neurons from earlier
nclear3d()

# Plot BANC DNg12 neurons in blue
cat("Plotting BANC neurons...\n")
n_banc_plot <- min(5, length(neurons_um))
for (i in 1:n_banc_plot) {
  plot3d(neurons_um[[i]], col = "darkblue", lwd = 2, add = TRUE)
}

# Plot transformed MANC DNg12 neurons in green
cat("Plotting transformed MANC neurons...\n")
for (i in 1:length(manc_dng12_banc_um)) {
  plot3d(manc_dng12_banc_um[[i]], col = "darkgreen", lwd = 2, add = TRUE)
}

title3d(main = "Co-visualisation: BANC (blue) vs MANC (green) DNg12 Neurons",
        xlab = "X (µm)", ylab = "Y (µm)", zlab = "Z (µm)")

cat("\nNote: MANC neurons were transformed through MANC -> JRCVNC2018F -> BANC\n")
```

You can also `xform_brain` any other data with 3D points, e.g. meshes (`mesh3d` objects), and data frames or matrices (with `x`,`y` and `z` columns), e.g. synapse data.

## NBLAST

Now that we have seen how to visualise the skeleton of one neuron, let's grab all of our neurons from this neuropil and assess how similar they are.

This method relies on decomposing neurons into directed vector clouds, whose alignment in Euclidean space can be compared.

<p align="center">
  <img src="../inst/images/NBLAST_neuron_comparison.png" alt="NBLAST algorithm" width="100%">
</p>

Let's just deal with intrinsic neurons of the ventral nerve cord that are already marked as restricted to a single leg neuromere, to make this a little faster.

To read all the neurons, we can select just our subset from the skeleton directory:

```{r read_all_neurons}
# Create list of SWC file names for our neuron IDs
# Limit to first 50 for performance in this example
meta_ids <- meta %>%
  filter(super_class=="ventral_nerve_cord_intrinsic",
         cell_class == "single_leg_neuromere") %>%
  distinct(cell_type, .keep_all = TRUE) %>% # we should not usually do this, but for speed reasons during the tutorial, just one skeleton per cell type
  pull(id)
cat("Reading", length(meta_ids), "neurons from skeleton directory...\n")
neurons <- read_neurons_dir(
  dir_path = skeletons_path,
  neuron_ids = meta_ids,
  gcs_filesystem = gcs_fs
)
cat("Loaded", length(neurons), "neurons\n")
```

We can now convert them from 1. nm to µm, and 2. to a 'dotprops' vector cloud, and use this to run an [NBLAST](https://natverse.org/nat.nblast/)!

```{r nblast_analysis, eval=FALSE}
# Convert from nm to um (microns)
neurons_um <- neurons / 1000

# Convert to dotprops (point cloud with tangent vectors)
# This removes detail but preserves spatial structure
neurons_dp <- dotprops(neurons_um, resample = 3, k = 3, .parallel = TRUE)

cat("Converted to dotprops representation\n")

# Run NBLAST all-by-all comparison
# This computes morphological similarity scores
cat("Running NBLAST (this may take a moment)...\n")
# Use smat=NULL to use raw dot product scores
nblast_scores <- nat.nblast::nblast_allbyall(neurons_dp, UseAlpha = TRUE, .parallel = TRUE)

cat("NBLAST complete!\n")
cat("Score matrix dimensions:", dim(nblast_scores), "\n")
```

Let's visualise the result as a dendrogram:

```{r nblast_dendrogram, eval=FALSE}
# Perform hierarchical clustering on NBLAST scores
nblast_hc <- nhclust(scoremat = nblast_scores)

# Cut the dendrogram into k clusters
k <- 20
clusters <- cutree(nblast_hc, k = k)
cat("Divided neurons into", k, "clusters\n")
table(clusters)

# Get the height at which to cut for k clusters
cut_height <- nblast_hc$height[length(nblast_hc$height) - k + 1]

# Create dendrogram data for ggplot2
library(ggdendro)
dend_data <- dendro_data(as.dendrogram(nblast_hc))

# Add cluster information to the leaf labels
dend_data$labels$cluster <- clusters[match(as.numeric(dend_data$labels$label),
                                            order.dendrogram(as.dendrogram(nblast_hc)))]

# Create a color palette for clusters
cluster_colors <- setNames(rainbow(k), 1:k)

# Create ggplot2 dendrogram with colored leaves and cut line
p_dend <- ggplot() +
  geom_segment(data = dend_data$segments,
               aes(x = x, y = y, xend = xend, yend = yend),
               color = "grey50", linewidth = 0.5) +
  geom_point(data = dend_data$labels,
             aes(x = x, y = y, color = factor(cluster)),
             size = 2, show.legend = TRUE) +
  geom_hline(yintercept = cut_height, linetype = "dashed",
             color = "red", linewidth = 0.8) +
  scale_color_manual(values = cluster_colors, name = "Cluster") +
  labs(
    title = paste("Hierarchical Clustering of Neuron Morphology (NBLAST)"),
    subtitle = paste0(dataset, " - ", subset_name, " (k = ", k, " clusters)"),
    x = "Neurons",
    y = "Height"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  ) +
  annotate("text", x = Inf, y = cut_height,
           label = paste("Cut height (k =", k, ")"),
           hjust = 1.1, vjust = -0.5, color = "red", size = 3)

# Save static version
save_plot(p_dend, paste0(dataset, "_", subset_name, "_nblast_dendrogram"),
          width = 12, height = 8)

# Create and display interactive plotly version
p_dend_plotly <- ggplotly(p_dend, tooltip = c("y")) %>%
  layout(
    hovermode = "closest",
    title = list(
      text = paste0("Hierarchical Clustering of Neuron Morphology (NBLAST)<br>",
                   "<sub>", dataset, " - ", subset_name, " (k = ", k, " clusters)</sub>"),
      x = 0.5,
      xanchor = 'center'
    )
  )

p_dend_plotly
```

Great, now let's view ~20 clusters by morphology:

```{r visualize_clusters, eval=FALSE, fig.width=10, fig.height=8}
# Plot neurons colored by cluster
nclear3d()
plot3d(neurons,col=neuron_colors, soma = 10000)
title3d(main = paste(k, "Morphological Clusters"),
        xlab = "X (µm)", ylab = "Y (µm)", zlab = "Z (µm)")
```

You can try playing with the number of clusters, `k`.

Cool! What do you think all of these neurons do?

## New Dataset (Coming Soon)

*Note: This section demonstrates cross-dataset co-visualisation once additional datasets like maleCNS or MANC have their skeleton data uploaded to the bucket. For now, we'll continue exploring BANC data.*

<!--
When malecns skeleton data is available, you can load it like this:

```{r load_malecns, eval=FALSE}
# Switch to maleCNS dataset
dataset2 <- "malecns"
subset_name2 <- "front_leg"

# Construct paths for maleCNS
base_path2 <- file.path("gs://brain-and-nerve-cord_exports/sjcabs_data", dataset2)
meta_path2 <- file.path(base_path2, paste0(dataset2, "_09_meta.feather"))
# Use banc_space skeletons for co-visualization (now in directory)
skeletons_path2 <- file.path(base_path2, paste0(dataset2, "_banc_space_swc"))

# Read and filter meta data
temp_feather2 <- tempfile(fileext = ".feather")
system(paste("gsutil cp", meta_path2, temp_feather2))
meta2_full <- read_feather(temp_feather2)
unlink(temp_feather2)

meta2 <- meta2_full %>%
  filter(grepl(neuropil_pattern, neuropil, ignore.case = FALSE))
neuron_ids2 <- meta2$id

# Read neurons using helper function (sample for performance)
n_sample2 <- min(50, length(neuron_ids2))

cat("Reading", n_sample2, "maleCNS neurons from skeleton directory...\n")
neurons_malecns <- read_neurons_dir(
  dir_path = skeletons_path2,
  neuron_ids = neuron_ids2[1:n_sample2],
  gcs_filesystem = gcs_fs
)

# Convert to microns
neurons_malecns_um <- neurons_malecns / 1000
```

Then visualize both datasets together:

```{r covisualize, eval=FALSE}
# Plot both datasets together in BANC space
clear3d()

# Plot BANC neurons in blue
for (i in 1:min(20, length(neurons_um))) {
  plot3d(neurons_um[[i]], col = "darkblue", lwd = 1, add = TRUE)
}

# Plot maleCNS neurons in red
for (i in 1:min(20, length(neurons_malecns_um))) {
  plot3d(neurons_malecns_um[[i]], col = "darkred", lwd = 1, add = TRUE)
}

title3d(main = "Co-visualisation: BANC (blue) vs maleCNS (red) Leg Neurons",
        xlab = "X (µm)", ylab = "Y (µm)", zlab = "Z (µm)")
```
-->

## Your Turn: New Subset

Now try this analysis yourself with a different subset, e.g., antennal lobe!

Simply change the `subset_name` variable at the top of the tutorial and re-run the analysis.

## Extension: Axon-Dendrite Splits (Coming Soon)

For all of our datasets, except BANC right now, we have axon-dendrite splits that have been pre-calculated.

This uses a graph theoretic algorithm from [Schneider-Mizell et al. 2016](https://elifesciences.org/articles/12059) (see the paper).

The method relies on the idea that information runs from input to output synapses, and determines axon versus dendrites by "cutting" the neuron at its major information bottleneck, and observing which half has more input/output.

The `label` column in the underlying `.swc` files gives the compartment.

In addition, the `pre_label` and `post_label` columns in our synapse tables give compartments.

*Note: This section will be available once maleCNS skeleton data with compartment labels is uploaded. Below is the code framework for when that data becomes available.*

<!--
When maleCNS data with compartment labels is available, you can visualize DNa01 neurons like this:

We will look at the neurons DNa01. To do this we must:

1. Read the meta file, filter for DNa01 on `cell_type`
2. Find its IDs, and read them from the `.swc` skeleton directory
3. Read these skeletons in, then subset by "label"
4. Visualise these compartments in different colours

Let's use four colours:

- **blue** = dendrite
- **green** = primary dendrite (linker)
- **orange** = axon
- **purple** = primary neurite tract (cell body fiber tract)

```{r compartment_visualization, eval=FALSE, fig.width=10, fig.height=8}
# Read maleCNS meta data (use full meta, not subset)
full_meta_path <- file.path(base_path2, paste0(dataset2, "_meta.csv"))
temp_csv3 <- tempfile(fileext = ".csv")
system(paste("gsutil cp", full_meta_path, temp_csv3))
malecns_meta <- read_csv(temp_csv3, show_col_types = FALSE)
unlink(temp_csv3)

# Filter for DNa01 neurons
dna01_meta <- malecns_meta %>%
  filter(cell_type == "DNa01")

cat("Found", nrow(dna01_meta), "DNa01 neurons\n")

if (nrow(dna01_meta) > 0) {
  # Get neuron IDs
  dna01_ids <- dna01_meta$id

  # Read neurons from skeleton directory using helper function
  skeletons_path_malecns <- file.path(base_path2, paste0(dataset2, "_skeletons"))

  cat("Reading", length(dna01_ids), "DNa01 neurons from skeleton directory...\n")
  dna01_neurons <- read_neurons_dir(
    dir_path = skeletons_path_malecns,
    neuron_ids = dna01_ids,
    gcs_filesystem = gcs_fs
  )

  # Convert to microns
  dna01_neurons_um <- dna01_neurons / 1000

  # Define compartment colors
  # label values: 2=dendrite, 3=axon, 4=primary_dendrite, 5=primary_neurite
  compartment_colors <- c(
    "2" = "blue",        # dendrite
    "3" = "orange",      # axon
    "4" = "green",       # primary_dendrite
    "5" = "purple"       # primary_neurite
  )

  # Plot neurons colored by compartment
  nclear3d()

  for (i in 1:length(dna01_neurons_um)) {
    neuron <- dna01_neurons_um[[i]]

    # Extract label for each point
    if ("Label" %in% names(neuron$d)) {
      labels <- as.character(neuron$d$Label)

      # Plot each compartment separately
      for (label_val in unique(labels)) {
        idx <- which(labels == label_val)
        if (length(idx) > 0) {
          color <- compartment_colors[label_val]
          if (is.na(color)) color <- "grey"

          # Create temporary neuron with just this compartment
          temp_d <- neuron$d[idx, ]
          plot3d(temp_d[, c("X", "Y", "Z")],
                 type = "l", col = color, lwd = 2, add = TRUE)
        }
      }
    } else {
      # If no label, plot whole neuron in grey
      plot3d(neuron, col = "grey", lwd = 1, add = TRUE)
    }
  }

  title3d(main = "DNa01 Neurons: Compartments",
          xlab = "X (µm)", ylab = "Y (µm)", zlab = "Z (µm)")

  # Add legend (manual)
  cat("\nCompartment colors:\n")
  cat("  Blue = dendrite\n")
  cat("  Green = primary dendrite\n")
  cat("  Orange = axon\n")
  cat("  Purple = primary neurite tract\n")
}
```

We can also see the synapses by this split.

Let's read the `.feather` file in our data subset, and select just those synapses related to our neurons.

Let's use four colours:

- **navy** = input synapse, dendrite
- **cyan** = input synapse, axon
- **pink** = output synapse, dendrite
- **red** = output synapse, axon

```{r compartment_synapses, eval=FALSE, fig.width=10, fig.height=8}
if (nrow(dna01_meta) > 0) {
  # Read synapses for DNa01 neurons
  synapses_path_full <- file.path(base_path2, paste0(dataset2, "_synapses.feather"))
  temp_feather2 <- tempfile(fileext = ".feather")
  system(paste("gsutil cp", synapses_path_full, temp_feather2))

  dna01_synapses <- read_feather(temp_feather2) %>%
    filter(pre %in% dna01_ids | post %in% dna01_ids)

  # Clean up
  unlink(temp_feather2)

  cat("Found", nrow(dna01_synapses), "synapses for DNa01 neurons\n")

  # Create synapse classification
  # Determine if input (post) or output (pre)
  # Determine compartment label
  dna01_synapses <- dna01_synapses %>%
    mutate(
      is_output = pre %in% dna01_ids,
      is_input = post %in% dna01_ids,
      compartment = case_when(
        is_output & !is.na(pre_label) ~ pre_label,
        is_input & !is.na(post_label) ~ post_label,
        TRUE ~ NA_real_
      ),
      syn_color = case_when(
        is_input & compartment == 2 ~ "navy",      # input, dendrite
        is_input & compartment == 3 ~ "cyan",      # input, axon
        is_output & compartment == 2 ~ "pink",     # output, dendrite
        is_output & compartment == 3 ~ "red",      # output, axon
        TRUE ~ "grey"
      )
    )

  # Convert to microns
  dna01_synapses <- dna01_synapses %>%
    mutate(x = x / 1000, y = y / 1000, z = z / 1000)

  # Plot synapses on top of neurons
  for (color in c("navy", "cyan", "pink", "red", "grey")) {
    syn_subset <- dna01_synapses %>% filter(syn_color == color)
    if (nrow(syn_subset) > 0) {
      points3d(syn_subset$x, syn_subset$y, syn_subset$z,
               col = color, size = 3)
    }
  }

  title3d(main = "DNa01 Neurons: Compartmental Synapses",
          xlab = "X (µm)", ylab = "Y (µm)", zlab = "Z (µm)")

  # Print legend
  cat("\nSynapse colors:\n")
  cat("  Navy = input synapse, dendrite\n")
  cat("  Cyan = input synapse, axon\n")
  cat("  Pink = output synapse, dendrite\n")
  cat("  Red = output synapse, axon\n")
}
```
-->

## Session Information

```{r session_info}
sessionInfo()
```












