---
title: "Tutorial 02: Neuron Morphology"
author: "Alexander Bates"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: show
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 8,
  cache = FALSE
)

# Setup image output directory
img_dir <- "images/tutorial_02"
if (!dir.exists(img_dir)) {
  dir.create(img_dir, recursive = TRUE)
}

# Helper function to save plots
save_plot <- function(plot_obj, name, width = 10, height = 6) {
  filename <- file.path(img_dir, paste0(name, ".png"))
  ggsave(filename, plot_obj, width = width, height = height, dpi = 300, bg = "white")
}
```

```{r packages, include=FALSE}
# Load required packages
source("setup/packages.R")
source("setup/functions.R")

# Set plotly as default 3D plot engine for nat
options(nat.plotengine = 'plotly')
```

## Introduction

The purpose of this tutorial is to examine neuron morphology.

We can visualise neurons, compare their morphological similarity with [NBLAST](https://natverse.org/nat.nblast/), and plot them with their synapses.

To do this, we are going to look at one of the data 'subsets' we have pre-prepared. 

I have subset the synapses and edgelist relevant for a few interesting areas, so let's use one of those.

You can change which subset and dataset to examine, by changing these two variables:

```{r setup_paths}
# Choose dataset and subset
dataset <- "banc_746"
dataset_id <- "banc_746_id"
data_path <- "gs://sjcabs_2025_data"
subset_name <- "front_leg"
neuropil_pattern <- "T1"

# Detect if using GCS or local path
use_gcs <- grepl("^gs://", data_path)

# Setup GCS filesystem if needed
gcs_fs <- if (use_gcs) setup_gcs_filesystem() else NULL

# Construct paths
meta_path <- construct_path(data_path, dataset, "meta")
skeletons_path <- construct_path(data_path, dataset, "skeletons")

# For subsets, construct paths to pre-filtered files
# Extract base dataset name (e.g., "banc" from "banc_746")
dataset_base <- sub("_[0-9]+$", "", dataset)
subset_dir <- file.path(data_path, dataset_base, subset_name)
edgelist_path <- file.path(subset_dir, paste0(dataset, "_", subset_name, "_simple_edgelist.feather"))
synapses_path <- file.path(subset_dir, paste0(dataset, "_", subset_name, "_synapses.feather"))

cat("Dataset:", dataset, "\n")
cat("Subset:", subset_name, "\n")
cat("Using GCS:", use_gcs, "\n")
```

But by default, let us look at the front leg neuropil!

This is available for BANC, maleCNS and MANC.

# Core tutorial

## Read Meta Data

Let's start by reading the meta data for our chosen subset:

```{r load_meta}
# Read the edgelist for this subset to get neuron IDs
edgelist <- read_feather_smart(edgelist_path, gcs_filesystem = gcs_fs)

# Get unique neuron IDs from pre and post columns
subset_ids <- unique(c(edgelist$pre, edgelist$post))

# Read full meta data using streaming approach
meta_full <- read_feather_smart(meta_path, gcs_filesystem = gcs_fs)

# Get proofread neuron IDs (key concept from Tutorial 01!)
proofread_ids <- meta_full[[dataset_id]]

# Filter meta for neurons in this subset
meta <- meta_full %>%
  filter(!!sym(dataset_id) %in% subset_ids)

# Rename ID column to 'id' for consistency
meta <- meta %>%
  rename(id = !!sym(dataset_id))
cat("Found", length(subset_ids), "unique neurons in", subset_name, "edgelist\n")
cat("(From", nrow(meta_full), "total proofread neurons)\n")
head(meta)
```

Let's now plot the neuron counts we have, by their super class:

```{r plot_counts}
# Count neurons by super_class
counts <- meta %>%
  count(super_class, sort = TRUE)

# Create bar plot
p <- ggplot(counts, aes(x = reorder(super_class, n), y = n, fill = super_class)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), hjust = -0.2, size = 3.5) +
  coord_flip() +
  labs(
    title = paste0("Neuron Counts in ", toupper(dataset), " ", subset_name, " Neuropil"),
    x = "Super Class",
    y = "Number of Neurons"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.grid.major.y = element_blank()
  )

save_plot(p, paste0(dataset, "_", subset_name, "_neuron_counts"))
```

That's quite a lot of neurons, but not too many.

Let's make a vector of their IDs.

```{r get_ids}
# Extract neuron IDs
neuron_ids <- meta$id
cat("Total neurons:", length(neuron_ids), "\n")

# Show first few IDs
head(neuron_ids)
```

## Read .swc File

A [.swc file](http://www.neuronland.org/NLMorphologyConverter/MorphologyFormats/SWC/Spec.html) is a format for encoding neuron 'skeleton' structure.

In short, a neuron can be represented as a tree graph, in which each node has a specified "parent", except the "root". When possible, we usually "root" the neuron at the soma, i.e. cell body.

We could work with high-resolution mesh data (not in our Google bucket), but for most tasks a skeleton suffices and is faster.

If you would like to see how to read in mesh data for the BANC project, which enables nice visualisations, see [here](https://flyconnectome.github.io/bancr/reference/banc_read_neuron_meshes.html).

Let's just take one cell type to start, why not DNg12, known to play a role in the control of the front legs during [grooming](https://www.sciencedirect.com/science/article/pii/S0960982221017425).

We can read its .swc file straight from the skeleton directories (our helper functions work with both directories and .zip archives).

We can visualise it in BANC space, or in its native space if not a BANC neuron. For non-BANC datasets we provide two spaces, because visualising everything in BANC space assists us with co-visualisation. We will see an example of this later.

For now, let's read and plot that neuron!

```{r read_single_neuron}
# Get all DNg12 neurons
meta_dng12 <- meta %>%
  filter(grepl("DNg12", cell_type))

neuron_ids <- meta_dng12$id
cat("Found", length(neuron_ids), "DNg12 neurons\n")

# Read all neurons using simplified function
neurons <- read_neurons_dir(
  dir_path = skeletons_path,
  neuron_ids = neuron_ids,
  gcs_filesystem = gcs_fs
)


# For visualization, we'll use the first neuron
neuron <- neurons[[1]]
selected_id <- names(neurons)[1]

summary(neuron)
```

Now let's visualize this neuron interactively with plotly:

```{r plot3d_neuron, fig.width=8, fig.height=6}
# Plot single neuron with plotly (default engine)
nclear3d()
plot3d(neuron, col = "darkblue", lwd = 2, soma = 10000)
```

We can also plot multiple neurons in different colors:

```{r plot3d_multiple_neurons, fig.width=8, fig.height=6}
# Plot multiple neurons with different colors
nclear3d()
plot3d(neurons, col = rainbow(length(neurons)), lwd = 2, soma = 10000)
```

Fo publication-ready 2D images, see our [nat.ggplot](https://github.com/natverse/nat.ggplot?tab=readme-ov-file) libraries and the tutorial in its  `README`.

## Read Neuropil Meshes

In our `obj` folder, we have some useful neuroanatomical objects!

We can also show the mesh of the BANC brains and ventral nerve cord neuropils, to help contextualise this morphology.

You can find its `.obj` file in our prepared data, and visualise it with our neuron as so.

```{r simple_mesh_example, eval=TRUE, fig.width=8, fig.height=6}
# Construct paths to mesh directories
# Large anatomical regions (VNC, brain, etc.) are in obj/ directory
region_path <- file.path(data_path, dataset_base, "obj")
region_files <- system(paste("gsutil ls", region_path), intern = TRUE)
vnc_obj <- region_files[grepl("vnc.*\\.obj$", region_files, ignore.case = TRUE)][1]
brain_obj <- region_files[grepl("brain.*\\.obj$", region_files, ignore.case = TRUE)][1]

# Download and read the mesh
temp_mesh <- tempfile(fileext = ".obj")
system(paste("gsutil cp", vnc_obj, temp_mesh))
vnc_mesh <- as.hxsurf(rgl::readOBJ(temp_mesh))
temp_mesh <- tempfile(fileext = ".obj")
system(paste("gsutil cp", brain_obj, temp_mesh))
brain_mesh <- as.hxsurf(rgl::readOBJ(temp_mesh))

# Visualize multiple neurons with neuropil mesh using plotly
nclear3d()
plot3d(vnc_mesh, col = "lightblue", alpha = 0.3)
plot3d(brain_mesh, col = "lightblue", alpha = 0.3)
plot3d(neurons, col = rainbow(length(neurons)), lwd = 2, soma = 10000)
```

Let's fetch both the BANC ventral nerve cord neuropil, and the leg neuropil.

We can show them over our neurons, with a little transparency.

```{r plot_with_neuropil, fig.width=10, fig.height=8}
# Smaller specific neuropils are in obj/neuropils/ subdirectory
neuropil_path <- file.path(data_path, dataset_base, "obj", "neuropils")

# List available OBJ files in the bucket
neuropil_files <- system(paste("gsutil ls", neuropil_path), intern = TRUE)

# Find VNC and leg neuropil meshes
leg_obj <- neuropil_files[grepl(neuropil_pattern, basename(neuropil_files))][1]
cat("Leg mesh:", leg_obj, "\n")

# Download and read meshes
temp_leg <- tempfile(fileext = ".obj")
if (!is.na(leg_obj) && length(leg_obj) > 0) {
  system(paste("gsutil cp", leg_obj, temp_leg))
  leg_mesh <- as.hxsurf(rgl::readOBJ(temp_leg))
}

# Plot neurons with neuropil meshes using plotly
nclear3d()

# Plot multiple neurons in different colors
n_plot <- length(neurons)
dummy1<-plot3d(vnc_mesh, col = "lightgrey", alpha = 0.1)
dummy2<-plot3d(leg_mesh, col = "lightblue", alpha = 0.3, add = TRUE)
plot3d(neurons, col = rainbow(length(neurons)), lwd = 2, soma = 10000)
# This works for the rgl version of this plot: title3d(main = paste(n_plot,
# "DNg12 Neurons in Neuropil Context"), xlab = "X (nm)", ylab = "Y (nm)", zlab =
# "Z (nm)")
```

## Transform between template spaces

Different connectomic and light-level anatomical data are collected in different individuals, and their data may be "registered" to different [template brains](https://www.virtualflybrain.org/docs/concepts/bridging/).

This plot shows the common template brains, including connectomic datasets, and the transforms that we have precomputed:

<p align="center">
  <img src="../inst/images/bridging_graph.png" alt="Template Brain Bridging Graph" width="80%">
</p>

In R, these transforms can be accessed via [nat.flybrains](https://natverse.org/nat.flybrains/index.html)

In this workshop, for each dataset we already provide transformed .swc neuron morphology data in the native dataset AND in BANC. Synapse data is given in the native dataset's space (and may be in raw voxels, nanometers or microns).

This enables you to plot things from multiple datasets in BANC easily.

For example, we can switch to looking at the maleCNS data, and read DNg12 neurons from maleCNS. We can then co-plot them in BANC space, with our BANC DNg12 neurons:

```{r coplot_malecns_banc, eval=TRUE, fig.width=10, fig.height=8}
# Switch to maleCNS dataset
dataset_male <- "malecns_09"
dataset_male_id <- "malecns_09_id"

# Read maleCNS meta data
meta_male_path <- construct_path(data_path, dataset_male, "meta")
meta_male_full <- read_feather_smart(meta_male_path, gcs_filesystem = gcs_fs)

# Filter for epg neurons in maleCNS
meta_male_epg <- meta_male_full %>%
  filter(grepl("EPG", cell_type, ignore.case = TRUE))
cat("Found", nrow(meta_male_epg), "EPG neurons in maleCNS\n")

# Construct path to maleCNS skeletons in BANC space
skeletons_male_banc_path <- construct_path(data_path, dataset_male, "skeletons",
                                           space_suffix = "banc_space")

# Read maleCNS neurons (already in BANC space)
male_ids <- meta_male_epg[[dataset_male_id]]
neurons_male_banc <- read_neurons_dir(
  dir_path = skeletons_male_banc_path,
  neuron_ids = male_ids,
  gcs_filesystem = gcs_fs
)

# Co-plot BANC and maleCNS neurons
nclear3d()

# Plot BANC neurons in blue
dummy1<-plot3d(vnc_mesh, col = "lightgrey", alpha = 0.1)
dummy2<-plot3d(brain_mesh, col = "lightgrey", alpha = 0.1, add = TRUE)
dummy3<-plot3d(neurons, col = "navy", lwd = 2, soma = 10000)
plot3d(neurons_male_banc, col = "red", lwd = 2, soma = 10000)
```

However, if you want do do spatial transforms yourself, you will need to use `nat.templatebrains` and its `xform_brain` function. See Extenstion 1 in this document for details.

## NBLAST

Now that we have seen how to visualise the skeleton of one neuron, let's grab all of our neurons from this neuropil and assess how similar they are.

This method relies on decomposing neurons into directed vector clouds, whose alignment in Euclidean space can be compared.

<p align="center">
  <img src="../inst/images/NBLAST_neuron_comparison.png" alt="NBLAST algorithm" width="100%">
</p>

Let's just deal with intrinsic neurons of the ventral nerve cord that are already marked as restricted to a single leg neuromere, to make this a little faster.

To read all the neurons, we can select just our subset from the skeleton directory:

```{r read_all_neurons}
# Create list of SWC file names for our neuron IDs
# Limit to first 50 for performance in this example
meta_ids <- meta %>%
  filter(super_class=="ventral_nerve_cord_intrinsic",
         cell_class == "single_leg_neuromere") %>%
  distinct(cell_type, .keep_all = TRUE) %>% # we should not usually do this, but for speed reasons during the tutorial, just one skeleton per cell type
  pull(id)
neurons <- read_neurons_dir(
  dir_path = skeletons_path,
  neuron_ids = meta_ids,
  gcs_filesystem = gcs_fs
)
```

We can now convert them from 1. nm to µm, and 2. to a 'dotprops' vector cloud, and use this to run an [NBLAST](https://natverse.org/nat.nblast/)!

```{r nblast_analysis, eval=TRUE}
# Convert from nm to um (microns)
neurons_um <- neurons / 1000

# Convert to dotprops (point cloud with tangent vectors)
# This removes detail but preserves spatial structure
neurons_dp <- dotprops(neurons_um, resample = 3, k = 3, .parallel = TRUE)


# Run NBLAST all-by-all comparison
# This computes morphological similarity scores
# Use smat=NULL to use raw dot product scores
nblast_scores <- nat.nblast::nblast_allbyall(neurons_dp, UseAlpha = TRUE)

```

Let's visualise the result as a dendrogram:

```{r nblast_dendrogram, eval=TRUE}
# Perform hierarchical clustering on NBLAST scores
nblast_hc <- nhclust(scoremat = nblast_scores)

# Cut the dendrogram into k clusters
k <- 8
clusters <- cutree(nblast_hc, k = k)
cat("Divided neurons into", k, "clusters\n")
table(clusters)

# Get the height at which to cut for k clusters
cut_height <- nblast_hc$height[length(nblast_hc$height) - k + 1]

# Create dendrogram data for ggplot2
dend_data <- dendro_data(as.dendrogram(nblast_hc))

# Get the dendrogram order and map back to neuron IDs
dend_order <- order.dendrogram(as.dendrogram(nblast_hc))
neuron_names <- names(neurons)

# Add cluster information and neuron IDs to the leaf labels
dend_data$labels$cluster <- clusters[dend_data$labels$label]
dend_data$labels$cell_type <- meta$cell_type[match(dend_data$labels$label,meta$id)]

# Create a color palette for clusters
cluster_colors <- setNames(rainbow(k), 1:k)
neuron_colors <- cluster_colors[dend_data$labels$cluster]
names(neuron_colors) <- dend_data$labels$label

# Create ggplot2 dendrogram with colored leaves and cut line
p_dend <- ggplot() +
  geom_segment(data = dend_data$segments,
               aes(x = x, y = y, xend = xend, yend = yend),
               color = "grey50", linewidth = 0.5) +
  geom_point(data = dend_data$labels,
             aes(x = x, y = y, color = factor(cluster), text = cell_type),
             size = 2, show.legend = TRUE) +
  geom_hline(yintercept = cut_height, linetype = "dashed",
             color = "red", linewidth = 0.8) +
  scale_color_manual(values = cluster_colors, name = "Cluster") +
  labs(
    title = paste("Hierarchical Clustering of Neuron Morphology (NBLAST)"),
    subtitle = paste0(dataset, " - ", subset_name, " (k = ", k, " clusters)"),
    x = "Neurons",
    y = "Height"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  ) +
  annotate("text", x = Inf, y = cut_height,
           label = paste("Cut height (k =", k, ")"),
           hjust = 1.1, vjust = -0.5, color = "red", size = 3)

# Save static version
save_plot(p_dend, paste0(dataset, "_", subset_name, "_nblast_dendrogram"),
          width = 12, height = 8)

# Create and display interactive plotly version with neuron ID hover text
p_dend_plotly <- ggplotly(p_dend, tooltip = c("text", "y", "colour")) %>%
  layout(
    hovermode = "closest",
    title = list(
      text = paste0("Hierarchical Clustering of Neuron Morphology (NBLAST)<br>",
                   "<sub>", dataset, " - ", subset_name, " (k = ", k, " clusters)</sub>"),
      x = 0.5,
      xanchor = 'center'
    )
  )

p_dend_plotly
```

Great, now let's view ~20 clusters by morphology:

```{r visualize_cluster_1, eval=TRUE, fig.width=10, fig.height=8}
# Plot neurons colored by cluster
nclear3d()
dummy<-plot3d(leg_mesh, col = "lightgrey", alpha = 0.1, add = TRUE)
plot3d(neurons[names(clusters)[clusters==1]], col = cluster_colors[1], soma = 10000)
```

```{r visualize_cluster_2, eval=TRUE, fig.width=10, fig.height=8}
# Plot neurons colored by cluster
nclear3d()
dummy<-plot3d(leg_mesh, col = "lightgrey", alpha = 0.1, add = TRUE)
plot3d(neurons[names(clusters)[clusters==2]], col = cluster_colors[2], soma = 10000)
```

```{r visualize_cluster_3, eval=TRUE, fig.width=10, fig.height=8}
# Plot neurons colored by cluster
nclear3d()
dummy<-plot3d(leg_mesh, col = "lightgrey", alpha = 0.1, add = TRUE)
plot3d(neurons[names(clusters)[clusters==3]], col = cluster_colors[3], soma = 10000)
```

```{r visualize_cluster_4, eval=TRUE, fig.width=10, fig.height=8}
# Plot neurons colored by cluster
nclear3d()
dummy<-plot3d(leg_mesh, col = "lightgrey", alpha = 0.1, add = TRUE)
plot3d(neurons[names(clusters)[clusters==4]], col = cluster_colors[4], soma = 10000)
```

```{r visualize_cluster_5, eval=TRUE, fig.width=10, fig.height=8}
# Plot neurons colored by cluster
nclear3d()
dummy<-plot3d(leg_mesh, col = "lightgrey", alpha = 0.1, add = TRUE)
plot3d(neurons[names(clusters)[clusters==5]], col = cluster_colors[5], soma = 10000)
```

```{r visualize_cluster_6, eval=TRUE, fig.width=10, fig.height=8}
# Plot neurons colored by cluster
nclear3d()
dummy<-plot3d(leg_mesh, col = "lightgrey", alpha = 0.1, add = TRUE)
plot3d(neurons[names(clusters)[clusters==6]], col = cluster_colors[6], soma = 10000)
```

```{r visualize_cluster_7, eval=TRUE, fig.width=10, fig.height=8}
# Plot neurons colored by cluster
nclear3d()
dummy<-plot3d(leg_mesh, col = "lightgrey", alpha = 0.1, add = TRUE)
plot3d(neurons[names(clusters)[clusters==7]], col = cluster_colors[7], soma = 10000)
```

```{r visualize_cluster_8, eval=TRUE, fig.width=10, fig.height=8}
# Plot neurons colored by cluster
nclear3d()
dummy<-plot3d(leg_mesh, col = "lightgrey", alpha = 0.1, add = TRUE)
plot3d(neurons[names(clusters)[clusters==8]], col = cluster_colors[8], soma = 10000)
```

You can try playing with the number of clusters, `k`.

Cool! What do you think all of these neurons do?

## Your Turn: New subset

Now try this analysis yourself with a different dataset!

**Exercise:** Switch the pre-prepared subset to `antennal_lobe`

```{r exercise, eval=FALSE}
# To work with a different dataset, change the dataset variable at the top:
# subset_name <- "antennal_lobe"
# neuropil_pattern <- "AL"

# Then re-run the entire notebook to see how the results differ!
```

# Extensions

In the extended code blocks, you can learn how to 1. transform data yourself between template spaces, and 2. visualise data split by axon and dendrite.

## Extension 1:

However, if you want do do spatial transforms yourself, you will need to use `nat.templatebrains` and its `xform_brain` function. A bit confusingly, we will also need [bancr](https://github.com/flyconnectome/bancr?tab=readme-ov-file) to complete the bridge to BANC space.

For example, let's read the native MANC neurons

```{r xform_manc_to_banc, eval=FALSE, fig.width=10, fig.height=8}
# Download template brain registrations (only needs to be done once)
nat.flybrains::download_jefferislab_registrations() # one time only
nat.jrcbrains::download_saalfeldlab_registrations() # one time only
nat.jrcbrains::register_saalfeldlab_registrations()

# Switch to MANC dataset
dataset_manc <- "manc_121"
dataset_manc_id <- "manc_121_id"

# Read MANC meta data
meta_manc_path <- construct_path(data_path, dataset_manc, "meta")
meta_manc_full <- read_feather_smart(meta_manc_path, gcs_filesystem = gcs_fs)

# Filter for DNg12 neurons in MANC
meta_manc_dng12 <- meta_manc_full %>%
  filter(grepl("DNg12", cell_type, ignore.case = TRUE))
cat("Found", nrow(meta_manc_dng12), "DNg12 neurons in MANC\n")

# Construct path to MANC skeletons in native MANC space
skeletons_manc_path <- construct_path(data_path, dataset_manc, "skeletons",
                                      space_suffix = paste0(dataset_manc, "_manc_space"))

# Read MANC neurons in native space
manc_ids <- meta_manc_dng12[[dataset_manc_id]]
manc_dng12 <- read_neurons_dir(
  dir_path = skeletons_manc_path,
  neuron_ids = manc_ids,
  gcs_filesystem = gcs_fs
)

# Transform MANC neurons to JRCVNC2018F template brain
manc_dng12_jrcvnc2018f <- xform_brain(manc_dng12,
                                      sample = "MANC",
                                      reference = "JRCVNC2018F")

# Transform from JRCVNC2018F to BANC using bancr
manc_dng12_banc <- bancr::banc_to_JRC2018F(manc_dng12_jrcvnc2018f,
                                           region = "vnc",
                                           method = "tpsreg",
                                           banc.units = "nm",
                                           inverse = TRUE)

# Co-plot MANC neurons with BANC neurons from earlier
nclear3d()

# Plot  DNg12 neurons
dummy1<-plot3d(vnc_mesh, col = "lightgrey", alpha = 0.1)
dummy2<-plot3d(brain_mesh, col = "lightgrey", alpha = 0.1, add = TRUE)
dummy3<-plot3d(neurons, col = "navy", lwd = 2, soma = 10000)
dumm4<-plot3d(neurons_male_banc, col = "red", lwd = 2, soma = 10000)
dumm4<-plot3d(manc_dng12_banc, col = "green", lwd = 2, soma = 10000)
```

You can also `xform_brain` any other data with 3D points, e.g. meshes (`mesh3d` objects), and data frames or matrices (with `x`,`y` and `z` columns), e.g. synapse data.

## Extension 2: Axon-Dendrite Splits

For many of our datasets (but notably not BANC yet), we have axon-dendrite splits that have been pre-calculated using a graph-theoretic algorithm from [Schneider-Mizell et al. 2016](https://elifesciences.org/articles/12059).

The method determines axon versus dendrite by "cutting" the neuron at its major information bottleneck based on synapse distributions, observing which half has more inputs versus outputs.

**Data locations:**
- The `Label` column in `.swc` skeleton files gives compartment assignments
- The `pre_label` and `post_label` columns in synapse tables give compartment assignments

Let's visualize some olfactory projection neurons from **fafb** with compartments color-coded:

- **Blue** = dendrite
- **Green** = primary dendrite (linker)
- **Orange** = axon
- **Purple** = primary neurite tract (cell body fiber tract)

We'll plot projections from the V glomerulus, which sense CO2.

```{r compartment_visualization, eval=TRUE, fig.width=10, fig.height=8}
# Switch to fafb dataset for this example (has compartment labels)
dataset_fafb <- "fafb_783"
dataset_fafb_id <- "fafb_783_id"

# Read fafb meta data
meta_fafb_path <- construct_path(data_path, dataset_fafb, "meta")
meta_fafb <- read_feather_smart(meta_fafb_path, gcs_filesystem = gcs_fs)

# Filter for V_l2PN neurons (case-insensitive)
vpn_meta <- meta_fafb %>%
  filter(grepl("V_l2PN", cell_type, ignore.case = TRUE))
cat("Found", nrow(vpn_meta), "V_l2PN neurons in fafb\n")

# Only proceed if neurons are found
if (nrow(vpn_meta) > 0) {
  # Get neuron IDs (limit to first 3 for visualization)
  vpn_ids <- vpn_meta[[dataset_fafb_id]][1:min(3, nrow(vpn_meta))]

  # Construct path to fafb skeletons in BANC space (for co-visualization)
  skeletons_path <- construct_path(data_path, "fafb", "skeletons",
                                             space_suffix = "banc_space")

  # Read fafb neurons
  vpn_neurons <- read_neurons_dir(
    dir_path = skeletons_path,
    neuron_ids = vpn_ids,
    gcs_filesystem = gcs_fs
  )

  # Only plot if neurons were loaded successfully
  if (length(vpn_neurons) > 0) {
    # Plot neurons colored by compartment
    nclear3d()
    axon  <- hemibrainr::axonic_cable(vpn_neurons)
    dendrite  <- hemibrainr::dendritic_cable(vpn_neurons)
    linker  <- hemibrainr::primary_dendrite_cable(vpn_neurons)
    neurite  <- hemibrainr::primary_neurite_cable(vpn_neurons)

    if (length(axon) > 0) p<-plot3d(axon,col="orange")
    if (length(dendrite) > 0) p<-plot3d(dendrite,col="cyan")
    if (length(linker) > 0) p<-plot3d(linker,col="green")
    if (length(neurite) > 0) plot3d(neurite,col="purple",soma=1000)
  } else {
  }
} else {
  cat("⚠ No V_l2PN neurons found in FAFB - skipping compartment visualization\n")
}
```

We can also see the synapses by this split.

Let's read the `.feather` file in our data subset, and select just those synapses related to our neurons.

Let's use four colours:

- **navy** = input synapse, dendrite
- **cyan** = input synapse, axon
- **pink** = output synapse, dendrite
- **red** = output synapse, axon

```{r compartment_synapses, eval=TRUE, fig.width=10, fig.height=8}
# Only run if vpn_ids exists (from previous section)
if (exists("vpn_ids") && length(vpn_ids) > 0) {
  # Construct path to FAFB synapses file
  dataset <- "fafb_783"
  synapses_path <- file.path(data_path, "fafb", "antennal_lobe", paste0(dataset, "_antennal_lobe_synapses.feather"))

  # Read synapses and filter for V_l2PN neurons
  vpn_synapses <- read_feather_smart(synapses_path, gcs_filesystem = gcs_fs) %>%
    filter(pre %in% vpn_ids | post %in% vpn_ids)
  cat("Found", nrow(vpn_synapses), "synapses for V_l2PN neurons\n")

# Create synapse classification
# Determine if input (post) or output (pre)
# Determine compartment label (2=dendrite, 3=axon)
vpn_synapses_output_axons <- vpn_synapses %>%
  filter(pre%in%vpn_ids, pre_label=="axon") %>%
  xyzmatrix()
vpn_synapses_output_dendrites <- vpn_synapses %>%
  filter(pre%in%vpn_ids, pre_label=="dendrite") %>%
  xyzmatrix()
vpn_synapses_intput_axons <- vpn_synapses %>%
  filter(post%in%vpn_ids, post_label=="axon") %>%
  xyzmatrix()
vpn_synapses_input_dendrites <- vpn_synapses %>%
  filter(post%in%vpn_ids, post_label=="dendrite") %>%
  xyzmatrix()

# Plot with plotly
# p <- plot3d(vpn_neurons) # p is a plotly object

# Add synapse points as scatter3d traces
# Navy = input synapse, dendrite
if (nrow(vpn_synapses_input_dendrites) > 0) {
  p <- p %>% plotly::add_trace(
    x = vpn_synapses_input_dendrites[, 1],
    y = vpn_synapses_input_dendrites[, 2],
    z = vpn_synapses_input_dendrites[, 3],
    type = "scatter3d",
    mode = "markers",
    marker = list(size = 2, color = "navy", opacity = 0.6),
    name = "Input, dendrite",
    showlegend = TRUE
  )
}

# Cyan = input synapse, axon
if (nrow(vpn_synapses_intput_axons) > 0) {
  p <- p %>% plotly::add_trace(
    x = vpn_synapses_intput_axons[, 1],
    y = vpn_synapses_intput_axons[, 2],
    z = vpn_synapses_intput_axons[, 3],
    type = "scatter3d",
    mode = "markers",
    marker = list(size = 2, color = "cyan", opacity = 0.6),
    name = "Input, axon",
    showlegend = TRUE
  )
}

# Pink = output synapse, dendrite
if (nrow(vpn_synapses_output_dendrites) > 0) {
  p <- p %>% plotly::add_trace(
    x = vpn_synapses_output_dendrites[, 1],
    y = vpn_synapses_output_dendrites[, 2],
    z = vpn_synapses_output_dendrites[, 3],
    type = "scatter3d",
    mode = "markers",
    marker = list(size = 2, color = "pink", opacity = 0.6),
    name = "Output, dendrite",
    showlegend = TRUE
  )
}

# Red = output synapse, axon
if (nrow(vpn_synapses_output_axons) > 0) {
  p <- p %>% plotly::add_trace(
    x = vpn_synapses_output_axons[, 1],
    y = vpn_synapses_output_axons[, 2],
    z = vpn_synapses_output_axons[, 3],
    type = "scatter3d",
    mode = "markers",
    marker = list(size = 2, color = "red", opacity = 0.6),
    name = "Output, axon",
    showlegend = TRUE
  )
}

# Display the plot
  p
} else {
  cat("⚠ Skipping compartment synapse visualization - no V_l2PN neurons available\n")
}
```

To calculate axon-dendrite splits yourself, explore the split functions in R'd [hemibrainr](https://natverse.org/hemibrainr/reference/flow_centrality.html) and python's [navis](https://github.com/navis-org/navis).

## Extension 3: Plotting neuronal meshes

We do not have mesh data especially prepared for the course, like we do synapses, connectiivty, meta data and neuron skeletons. However, you can read mesh data directly from the major connectome projects, using R packages [`neuprintr`](https://natverse.org/neuprintr/), [`fafbseg`](https://github.com/natverse/fafbseg) and [`bancr`](https://github.com/flyconnectome/bancr?tab=readme-ov-file). 

For example, we can read each of the EPG neurons from the FAFB project and plot them in multi-color.

```{r neuron_meshes}
library(bancr)
epg.meta <- meta_full %>% filter(grepl("EPG",cell_type))
banc.meshes <- banc_read_neuron_meshes(epg.meta$banc_746_id)
plot3d(banc.meshes, col = rainbow(length(banc.meshes)))
```

## Session Information

```{r session_info}
sessionInfo()
```












